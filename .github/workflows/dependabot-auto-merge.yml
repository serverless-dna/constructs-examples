name: Dependabot Auto-Merge

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Permissions required for the workflow
permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge-dependabot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch and process Dependabot PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "Starting Dependabot Auto-Merge Process"
          echo "=========================================="
          echo ""
          
          # Get all open PRs created by dependabot
          echo "Fetching open Dependabot PRs..."
          prs=$(gh pr list \
            --author "app/dependabot" \
            --state open \
            --json number,title,mergeable,url,headRefName \
            --jq '.[]')
          
          if [ -z "$prs" ]; then
            echo "No open Dependabot PRs found."
            exit 0
          fi
          
          # Count PRs
          pr_count=$(echo "$prs" | jq -s 'length')
          echo "Found $pr_count open Dependabot PR(s)"
          echo ""
          
          # Process each PR
          echo "$prs" | jq -c '.' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            pr_url=$(echo "$pr" | jq -r '.url')
            pr_mergeable=$(echo "$pr" | jq -r '.mergeable')
            pr_branch=$(echo "$pr" | jq -r '.headRefName')
            
            echo "----------------------------------------"
            echo "Processing PR #$pr_number"
            echo "Title: $pr_title"
            echo "URL: $pr_url"
            echo "Branch: $pr_branch"
            echo ""
            
            # Check if PR is mergeable
            if [ "$pr_mergeable" != "MERGEABLE" ]; then
              echo "⚠️  SKIPPED: PR is not in mergeable state (status: $pr_mergeable)"
              echo "   This could be due to merge conflicts or required status checks."
              echo ""
              continue
            fi
            
            # Get check runs for the PR
            echo "Checking CI status..."
            checks=$(gh api \
              "repos/${{ github.repository }}/commits/$(gh pr view $pr_number --json headRefOid --jq '.headRefOid')/check-runs" \
              --jq '.check_runs[] | select(.status == "completed") | {name: .name, conclusion: .conclusion}')
            
            # Check if there are any checks
            if [ -z "$checks" ]; then
              echo "ℹ️  No CI checks found for this PR"
              checks_passing=true
            else
              # Check if all checks passed
              failed_checks=$(echo "$checks" | jq -r 'select(.conclusion != "success" and .conclusion != "skipped") | .name')
              
              if [ -z "$failed_checks" ]; then
                echo "✅ All CI checks passed"
                checks_passing=true
              else
                echo "❌ SKIPPED: Some CI checks failed or are pending:"
                echo "$failed_checks" | while read -r check_name; do
                  echo "   - $check_name"
                done
                checks_passing=false
              fi
            fi
            
            echo ""
            
            # If all conditions are met, merge the PR
            if [ "$checks_passing" = true ]; then
              echo "Attempting to merge PR #$pr_number..."
              
              if gh pr merge "$pr_number" \
                --auto \
                --squash \
                --delete-branch; then
                echo "✅ SUCCESS: PR #$pr_number merged and branch deleted"
                echo "   Action: Auto-merged and deleted branch '$pr_branch'"
              else
                echo "❌ ERROR: Failed to merge PR #$pr_number"
                echo "   The PR may have additional requirements or conflicts."
              fi
            else
              echo "⚠️  SKIPPED: PR #$pr_number does not meet merge criteria"
            fi
            
            echo ""
          done
          
          echo "=========================================="
          echo "Dependabot Auto-Merge Process Complete"
          echo "=========================================="
